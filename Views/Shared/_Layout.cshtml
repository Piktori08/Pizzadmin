<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8" />
    <link rel="apple-touch-icon" sizes="76x76" href="~/assets/img/apple-icon.png">
    <link rel="icon" type="image/png" href="~/assets/img/favicon.png">
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
    <title>
        @ViewData["Title"]
    </title>
    <meta content='width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0, shrink-to-fit=no' name='viewport' />
    <!--     Fonts and icons     -->
    <link href="https://fonts.googleapis.com/css?family=Montserrat:400,700,200" rel="stylesheet" />
    <link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.7.1/css/all.css" integrity="sha384-fnmOCqbTlWIlj8LyTjo7mOUStjsKC4pOpQbqyi7RrhN7udi9RwhKkMHpvLbHG9Sr" crossorigin="anonymous">
    <!-- CSS Files -->
    <link href="~/assets/css/bootstrap.min.css" rel="stylesheet" />
    <link href="~/assets/css/now-ui-dashboard.css?v=1.5.0" rel="stylesheet" />
    <!-- CSS Just for demo purpose, don't include it in your project -->
    <link href="~/assets/demo/demo.css" rel="stylesheet" />
    @* <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet"> *@
    <link rel="stylesheet" href="https://cdn.datatables.net/2.3.2/css/dataTables.dataTables.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/7.0.0/css/all.min.css" integrity="sha512-DxV+EoADOkOygM4IR9yXP8Sb2qwgidEmeqAEmDKIOfPRQZOWbXCzLC6vjbZyy0vPisbH2SyW27+ddLVCN+OMzQ==" crossorigin="anonymous" referrerpolicy="no-referrer" />
</head>
<style>
   
    li{
        list-style: none;
    }
 </style>
<body>
    <div class="wrapper ">
        <div class="sidebar" data-color="orange">
            <!--
                Tip 1: You can change the color of the sidebar using: data-color="blue | green | orange | red | yellow"
            -->
            <div class="logo">
                <a href="http://www.creative-tim.com" class="simple-text logo-mini">
                    PA
                </a>
                <a href="http://www.creative-tim.com" class="simple-text logo-normal">
                    Pizzadmin
                </a>
            </div>
            <div class="sidebar-wrapper" id="sidebar-wrapper">
                <ul class="nav">
                    <li class="@(ViewData["active"]?.ToString() == "dashboard" ? "active" : "")">
                        <a asp-controller="Home" asp-action="Index">
                            <i class="fa-solid fa-house"></i>
                            <p>Dashboard</p>
                        </a>
                    </li>
                    <li class="@(ViewData["active"]?.ToString() == "products" ? "active" : "")">
                        <a asp-controller="Product" asp-action="Index">
                            <i class="fa-solid fa-cube"></i>
                            <p>Products</p>
                        </a>
                    </li>
                    <li class="@(ViewData["active"]?.ToString() == "orders" ? "active" : "")">
                        <a asp-controller="Order" asp-action="Index">
                            <i class="fa-solid fa-bag-shopping"></i>
                            <p>Orders</p>
                        </a>
                    </li>
                    <li class="@(ViewData["active"]?.ToString() == "users" ? "active" : "")">
                        <a asp-controller="User" asp-action="Index">
                            <i class="fa-solid fa-users"></i>
                            <p>Users</p>
                        </a>
                    </li>
                </ul>
            </div>
        </div>
        <div class="main-panel" id="main-panel">
            <!-- Navbar -->
            <nav class="navbar navbar-expand-lg  bg-primary">
                <div class="container-fluid">
                    <div class="navbar-wrapper">
                        <div class="navbar-toggle">
                            <button type="button" class="navbar-toggler">
                                <span class="navbar-toggler-bar bar1"></span>
                                <span class="navbar-toggler-bar bar2"></span>
                                <span class="navbar-toggler-bar bar3"></span>
                            </button>
                        </div>
                        <a class="navbar-brand" href="#pablo">@ViewData["Title"]</a>
                    </div>
                    <button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navigation" aria-controls="navigation-index" aria-expanded="false" aria-label="Toggle navigation">
                        <span class="navbar-toggler-bar navbar-kebab"></span>
                        <span class="navbar-toggler-bar navbar-kebab"></span>
                        <span class="navbar-toggler-bar navbar-kebab"></span>
                    </button>
                    <div class="collapse navbar-collapse justify-content-end" id="navigation">
                        <form>
                            <div class="input-group no-border">
                                <input type="text" value="" class="form-control" placeholder="Search...">
                                <div class="input-group-append">
                                    <div class="input-group-text">
                                        <i class="now-ui-icons ui-1_zoom-bold"></i>
                                    </div>
                                </div>
                            </div>
                        </form>
                        <ul class="navbar-nav m-2">
                            <li class="nav-item" style="position: relative;">
                                <!-- 👈 Make parent relative -->
                                <a href="#" id="notificationBell">
                                    <i class="fas fa-bell"></i>
                                    <span id="notificationCount" class="badge">0</span>
                                </a>

                                <!-- Notifications dropdown -->
                                <div id="notificationDropdown"
                                     style="display: none;
                                            position: absolute;
                                            top: 100%;  /* 👈 ensures it drops below bell */
                                            right: 0;   /* 👈 aligns with the bell */
                                            background: white;
                                            border: 1px solid #ccc;
                                            width: 250px;
                                            max-height: 300px;
                                            overflow-y: auto;
                                            box-shadow: 0 4px 8px rgba(0,0,0,0.15);
                                            z-index: 9999;">
                                    <!-- 👈 makes sure it's on top -->
                                    <ul id="notificationsList"
                                        style="list-style: none; padding: 10px; margin: 0;">
                                    </ul>
                                </div>
                            </li>
                        </ul>

                        <ul class="navbar-nav">
                            <li class="nav-item dropdown">
                                <a class="nav-link dropdown-toggle" id="navbarDropdownMenuLink" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
                                    <i class="now-ui-icons users_single-02"></i>
                                    <p>
                                        <span class="d-lg-none d-md-block">Account</span>
                                    </p>
                                </a>
                                <div class="dropdown-menu dropdown-menu-right" aria-labelledby="navbarDropdownMenuLink">
                                    <a class="dropdown-item" href="#"><i class="fas fa-user"></i>Profile</a>
                                    <a class="dropdown-item" asp-controller="Account" asp-action="Logout"><i class="fas fa-lock"></i> Logout</a>
                                </div>
                            </li>
                        </ul>
                    </div>
                </div>
            </nav>
            <!-- End Navbar -->
            <div class="container-fluid pt-3">
                <main role="main" class="pb-3">
                    @RenderBody()
                </main>
            </div>
            <footer class="footer">
                <div class="container-fluid ">
                    <nav>
                        <ul>
                            <li>
                                <a href="https://www.creative-tim.com">
                                    Creative Tim
                                </a>
                            </li>
                            <li>
                                <a href="http://presentation.creative-tim.com">
                                    About Us
                                </a>
                            </li>
                            <li>
                                <a href="http://blog.creative-tim.com">
                                    Blog
                                </a>
                            </li>
                        </ul>
                    </nav>
                    <div class="copyright" id="copyright">
                        &copy; <script>
                                   document.getElementById('copyright').appendChild(document.createTextNode(new Date().getFullYear()))
                        </script>, Designed by <a href="https://www.invisionapp.com" target="_blank">Invision</a>. Coded by <a href="https://www.creative-tim.com" target="_blank">Creative Tim</a>.
                    </div>
                </div>
            </footer>
        </div>
    </div>




    <!--   Core JS Files   -->
    <script src="~/assets/js/core/jquery.min.js"></script>
    <script src="~/assets/js/core/popper.min.js"></script>
    <script src="~/assets/js/core/bootstrap.min.js"></script>
    <script src="~/assets/js/plugins/perfect-scrollbar.jquery.min.js"></script>
    @* <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script> *@

    <!--  Google Maps Plugin    -->
    <script src="https://maps.googleapis.com/maps/api/js?key=YOUR_KEY_HERE"></script>
    <!-- Chart JS -->
    <script src="~/assets/js/plugins/chartjs.min.js"></script>
    <!--  Notifications Plugin    -->
    <script src="~/assets/js/plugins/bootstrap-notify.js"></script>
    <!-- Control Center for Now Ui Dashboard: parallax effects, scripts for the example pages etc -->
    <script src="~/assets/js/now-ui-dashboard.min.js?v=1.5.0" type="text/javascript"></script><!-- Now Ui Dashboard DEMO methods, don't include it in your project! -->
    <script src="~/assets/demo/demo.js"></script>
    <script>
        $(document).ready(function() {
          // Javascript method's body can be found in assets/js/demos.js
          demo.initDashboardPageCharts();

        });
    </script>
    <script src="~/lib/microsoft/signalr/dist/browser/signalr.js"></script>
    <script>
        let connection;
        let notificationCount = 0;

        // Initialize when page loads
        document.addEventListener('DOMContentLoaded', function() {
            initializeNotificationSystem();
            loadExistingNotifications();
        });

        function initializeNotificationSystem() {
            // Create SignalR connection
            connection = new signalR.HubConnectionBuilder()
                .withUrl("/notificationHub")
                .build();

            // Handle incoming notifications
            connection.on("ReceiveNotification", function (message) {
                notificationCount++;
                updateNotificationBadge();
                addNotificationToList(message);
                showToastNotification(message);
            });

            // Start connection
            connection.start().then(function() {
                console.log("Notification system connected");
            }).catch(function(err) {
                console.error("Notification connection failed:", err.toString());
                setTimeout(initializeNotificationSystem, 5000);
            });

            // Handle connection close (auto-reconnect)
            connection.onclose(function() {
                console.log("Connection closed. Reconnecting...");
                setTimeout(initializeNotificationSystem, 3000);
            });

            // Setup bell click event
            setupNotificationBell();
        }

        function loadExistingNotifications() {
            fetch("/api/Pizzadmin/notifications")
                .then(res => {
                    if (!res.ok) throw new Error("Failed to fetch notifications");
                    return res.json();
                })
                .then(notifications => {
                    notifications.forEach(n => addNotificationToList(n.message));

                    // Update badge count
                    notificationCount = notifications.length;
                    updateNotificationBadge();
                })
                .catch(err => {
                    console.error("Error loading notifications:", err);
                });
        }

        function updateNotificationBadge() {
            const badge = document.getElementById("notificationCount");
            if (badge) {
                badge.textContent = notificationCount;
                badge.style.display = notificationCount > 0 ? "inline" : "none";
                if (notificationCount > 0) badge.classList.add("badge-danger");
                else badge.classList.remove("badge-danger");
            }
        }

        function addNotificationToList(message) {
            const list = document.getElementById("notificationsList");
            if (list) {
                const li = document.createElement("li");
                li.style.cssText = "padding: 8px; border-bottom: 1px solid #eee; margin-bottom: 5px;";
                li.innerHTML = `
                    <div style="font-size: 14px; color: #333;">${message}</div>
                    <small style="color: #666; font-size: 11px;">${new Date().toLocaleTimeString()}</small>
                `;
                list.prepend(li);

                while (list.children.length > 10) {
                    list.removeChild(list.lastChild);
                }
            }
        }

        function showToastNotification(message) {
            if (typeof Swal !== 'undefined') {
                Swal.fire({
                    title: "New Order!",
                    text: message,
                    icon: "success",
                    timer: 4000,
                    showConfirmButton: false,
                    position: 'top-end',
                    toast: true,
                    background: '#28a745',
                    color: 'white'
                });
            } else {
                console.log("New notification:", message);
            }
        }

        function setupNotificationBell() {
            const bell = document.getElementById("notificationBell");
            const dropdown = document.getElementById("notificationDropdown");

            if (bell && dropdown) {
                bell.addEventListener("click", function (e) {
                    e.preventDefault();
                    e.stopPropagation();

                    dropdown.style.display = (dropdown.style.display === "block") ? "none" : "block";

                    if (dropdown.style.display === "block") {
                        notificationCount = 0;
                        updateNotificationBadge();
                    }
                });

                document.addEventListener("click", function(e) {
                    if (!bell.contains(e.target) && !dropdown.contains(e.target)) {
                        dropdown.style.display = "none";
                    }
                });
            }
        }

        // Optional: Function to clear all notifications
        function clearAllNotifications() {
            const list = document.getElementById("notificationsList");
            if (list) list.innerHTML = '<li style="padding: 10px; text-align: center; color: #666;">No notifications</li>';
            notificationCount = 0;
            updateNotificationBadge();
        }
    </script>

      
    @await RenderSectionAsync("Scripts", required: false)
</body>
</html>
