<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Project</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.7/dist/css/bootstrap.min.css">
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/font-awesome/4.7.0/css/font-awesome.min.css">
    <link rel="stylesheet" href="./css/style.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/OwlCarousel2/2.3.4/assets/owl.carousel.css">
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.6.3/jquery.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/OwlCarousel2/2.3.4/owl.carousel.min.js"></script>

    <style>
         .total-card {
            height: auto;
        }

        .totalPrice {
            display: flex;
            flex-direction: column; /* Stack children vertically */
            justify-content: space-between;
        }

        .quantity-controls {
            margin-top: 10px;
        }

        .btn-quantity {
           width: 40px;
            height: 40px;
            border: 1px solid;
            font-size: 20px;
            /* padding: 14px; */
            text-align: center;
            border-radius: 50px;
            color: tomato;
            display: flex;
            justify-content: center;
            align-items: center;
            margin: 0 15px 0 15px;
        }

        .btn-quantity:hover {
            background-color: #efefef;
            color: rgb(255, 87, 57);
            text-decoration: none;
            cursor: pointer;
        }

        .quantity-display {
            font-weight: bold;
            min-width: 30px;
            text-align: center;
        }

        .btn-primary {
            background-color: #b80818 !important;
            border-color: #9a0613 !important;
        }

        .btn-primary:hover {
            box-shadow: 0 4px 10px firebrick;
        }
    </style>
</head>
<body>
    <div class="container-fluid">
        <nav class="navbar-expand-lg navbar-dark fixed-top ">
            <div class="container"> 
            <div class="row">
                <div class="col-lg-3 col-md-3 col-4">
                    <a class="navbar-brand" href="index.html"><img src="image/logo.png" alt=""></a>
                </div>
                <div class="col-lg-6 col-md-6 col-2">
                    <div class="collapse navbar-collapse justify-content-end" id="collapsibleNavbar">
                        <ul class="navbar-nav ml-auto">
                            <li class="nav-item"> <a class="nav-link" aria-current="page" href="index.html">Home</a> </li>
                            <li class="nav-item"> <a class="nav-link" href="#">Category</a> </li>
                            <li class="nav-item"> <a class="nav-link" href="#">Menu List</a> </li>
                            <li class="nav-item"> <a class="nav-link" href="#">Our Services</a> </li>
                            <li class="nav-item"> <a class="nav-link" href="#">Testimonial</a> </li>
                            <li class="nav-item"> <a class="nav-link" href="#">Contact Us</a> </li>
                        </ul>
                    </div>
                </div>
                <div class="col-lg-3 col-md-3 col-6 social-media">
                    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#collapsibleNavbar"> <span class="navbar-toggler-icon"></span> </button>
                    <a href="#"><i class="fa fa-search"></i></a>
                    <a href="cart.html"><i class="fa fa-cart-plus"></i></a>         
                </div>
            </div>
            </div>	
        </nav>
    </div>

    <div class="container-fluid main-section">
        <div class="container">
            <div class="row">
                <div class="col-12">
                    <div class="heading-section">
                        <h3>Our Top Sell</h3>
                        <h2>Checkout Our Top Sell Burger</h2>
                        <div class="heading-borders">
                            <span class="selected">

                            </span>
                        </div>
                    </div>
                </div>
            </div>
            <div class="row">
                <div class="col-md-8">
                    <div class="row" id="products-row">

                    </div>
                </div>
                <div class="col-md-4">
                    <div class="card total-card">
                        <div class="card-header">
                            <h4 class="card-title">Total</h4>
                        </div>
                        <div class="card-body">
                            <div class="total-body">
                                <!-- The row appends here -->
                            </div>
                            <hr/>
                            <div class="row">
                                <div class="col-md-12 totalPrice">
                                    <h5>Total Price: $<span id="full-total"></span></h5>
                                </div>
                            </div>
                            <button class="btn btn-primary" onclick="Save()"> <i class="fas fa-floppy-disk"></i> Order</button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <div class="container-fluid footer-section">
        <div class="container">
            <div class="row">
                <div class="col-md-8">
                    <div class="footer-top">
                        <h2>A Moments of Delivered <br> On Right Time & Place</h2>
                        <h3>90-92-81283412-811</h3>
                        <span class="border-bottoms"></span>
                    </div>
                </div>
                <div class="col-md-4">
                    <h2><img src="./image/logo.png" alt=""></h2>
                </div>
                </div>
                <div class="row">
            <div class="col-md-4">
            <h4>Our Company</h4>
            <div class="row">
                <div class="col-6">
                    <div class="footer-menu">
                        <ul>
                            <li>Home</li>
                            <li>Menu</li>
                            <li>About us</li>
                            <li>Restaurant</li>
                        </ul>
                    </div>
                </div>
                <div class="col-6">
                    <div class="footer-menu">
                        <ul>
                            <li>Quick Order</li>
                            <li>Fast Food</li>
                            <li>Blogging </li>
                            <li>Contact Us</li>
                        </ul>
                    </div>
                </div>
                </div>
                </div>
                <div class="col-md-4">
            <h4>Our Company</h4>
            <table>
                <tr> 
                    <td>Mon-Fri...</td>
                    <td>8.00 am - 12:00 pm</td>
                </tr>
                <tr>
                    <td>Saturday</td>
                    <td>8:00 am-12:00pm</td>
                </tr>
                <tr>
                    <td>Sunday.......</td>
                    <td>Closed</td>
                </tr>
            </table>
            </div>
            <div class="col-md-4">
            <h4>Contact Us</h4>
            <div class="contact-info">
                <p><span><i class="fa fa-map-marker"></i></span> 89,Rind Road,  New Delhi, India</p>
                <p><span><i class="fa fa-phone"></i></span>+91 9893 192091</p>
                <ul>
                    <li><i class="fa fa-instagram"></i></li>
                    <li><i class="fa fa-whatsapp"></i></li>
                    <li><i class="fa fa-youtube"></i></li>
                    <li><i class="fa fa-twitter"></i></li>
                </ul>
           </div> </div>
           </div>
        </div>
        <div class="container">
            <div class="row" class="copyright">
                <div class="col-md 6">
                    <p>All Copy Right by Devzen</p>
                </div>
            
            <div class="col-md-6">
                <ul>
                    <li><a href="#">Services</a></li>
                    <li><a href="#">Blog</a></li>
                    <li><a href="#">Contact</a></li>
                </ul>
            </div></div>
        </div>
        </div>
        
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.7/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/microsoft-signalr/6.0.1/signalr.min.js"></script>
    <script>
        let connection; 
        let totalPrice = 0;

        function plus(productId){

            var productName = document.getElementById("productName-" + productId).innerHTML;
            var productPrice = document.getElementById("productPrice-" + productId).innerHTML;
            
            let row = document.getElementById('row-' + productId);

            if (row == null){
            $('.total-body').append(
                     `<div class="row" id="row-${productId}">
                        <div class="col-md-6">
                            <span>
                                ${productName}
                            </span>
                        </div>
                        <div class="col-md-2">
                            <span id="spanQuantity-${productId}">1</span>
                        </div>
                        <div class="col-md-4">
                            <span id="spanPrice-${productId}">${productPrice}</span>
                        </div>
                    </div>`
                );
                totalPrice += parseFloat(productPrice);
                document.getElementById('full-total').innerHTML = totalPrice.toFixed(2);
            }
            else {
                let quantitySpan = document.getElementById('spanQuantity-' + productId);
                let currentQuantity = parseInt(quantitySpan.innerHTML);

                currentQuantity++;
                quantitySpan.innerHTML = currentQuantity;


                let priceSpan = document.getElementById('spanPrice-' + productId);
                let currentPrice = parseFloat(priceSpan.innerHTML);
                currentPrice += parseFloat(productPrice);
                priceSpan.innerHTML = currentPrice.toFixed(2);
                totalPrice += parseFloat(productPrice);
                document.getElementById('full-total').innerHTML = totalPrice.toFixed(2);
            }

            let quantitySpan = document.getElementById('spanQuantity-' + productId);
            
        }

        function minus(productId){
    
            var productName = document.getElementById("productName-" + productId).innerHTML;
            var productPrice = document.getElementById("productPrice-" + productId).innerHTML;

            let row = document.getElementById('row-' + productId);

            if (parseInt(document.getElementById('spanQuantity-' + productId).innerHTML) == null){
                $('.total-body').append(
                    `<div class="row" id="row-${productId}">
                        <div class="col-md-6">
                            <span>
                                
                            </span>
                        </div>
                        <div class="col-md-2">
                            <span id="spanQuantity-${productId}"> </span>
                        </div>
                        <div class="col-md-4">
                            <span id="spanPrice-${productId}"> </span>
                        </div>
                    </div>`
                );
            }
            else {

                let quantitySpan = document.getElementById('spanQuantity-' + productId);
                let currentQuantity = parseInt(quantitySpan.innerHTML);
                let row = document.getElementById('row-' + productId);
                let priceSpan = document.getElementById('spanPrice-' + productId);
                let currentPrice = parseFloat(priceSpan.innerHTML);

                if(currentQuantity> 0)
                    {
                    currentQuantity--;
                    quantitySpan.innerHTML = currentQuantity;
                    currentPrice -= parseFloat(productPrice);
                    priceSpan.innerHTML = currentPrice.toFixed(2);
                } else{
                    quantitySpan.innerHTML = currentQuantity;
                    priceSpan.innerHTML = currentPrice.toFixed(2);
                }
                    if (currentQuantity == 0) {
                        row.remove();
                    }
                totalPrice -= parseFloat(productPrice);
                document.getElementById('full-total').innerHTML = totalPrice.toFixed(2);

            }

            
        }

        

        fetch('https://localhost:44365/api/Pizzadmin')
        .then(response => {
            if (!response.ok) {
            throw new Error('Failed to fetch products');
            }
            return response.json();
        })
        .then(products => {
            console.log('Product list:', products);
            
            for (let i = 0; i < products.length; i++){
                $('#products-row').append(
                    `<div class="col-lg-4 col-md-6">
                        <div class="famous-product h-90 product-card">
                            <h2>BEEF</h2>
                            <h3 id="productName-${products[i].id}">${products[i].name}</h3>
                            <div class="card-img-container position-relative">
                                <img class="card-img-top" src="${products[i].imageUrl}" alt="">
                            </div>
                            <div class="price">
                                <h4 id="productPrice-${products[i].id}">${products[i].price}$</h4>
                                <p>220gr/600cal</p>
                                <div class="quantity-controls d-flex align-items-center justify-content-center mt-2">
                                    <a onclick="minus(${products[i].id})" class="btn-quantity">
                                        <span>
                                            <i class="fa fa-minus"></i>
                                        </span>
                                    </a>
                                    <a onclick="plus(${products[i].id})" class="btn-quantity">
                                        <span>
                                            <i class="fa fa-plus"></i>
                                        </span>
                                    </a>
                                </div>
                            </div>
                        </div>
                    </div>`
                );
            }

        })
        .catch(error => {
            console.error('Error fetching products:', error);
        });


        function Save(){
            let totalPrice = document.getElementById('full-total').innerHTML;
            
            const elements = document.querySelectorAll('[id^="spanQuantity-"]');
            const quantities = Array.from(elements).map(el => el.innerHTML);

            const pElements = document.querySelectorAll('[id^="spanPrice-"]');
            const productIds = Array.from(pElements).map(el => el.id.substring("spanPrice-".length));
            let connection;

            // Initialize SignalR when page loads
            document.addEventListener('DOMContentLoaded', function() {
                initializeSignalR();
            });

            function initializeSignalR() {
                connection = new signalR.HubConnectionBuilder()
                    .withUrl("/notificationHub") // Use relative URL if same domain, or full URL if different
                    .build();

                connection.start().then(() => {
                    console.log("Connected to SignalR hub");
                }).catch(err => {
                    console.error("SignalR connection failed:", err.toString());
                });

                // Listen for notifications from server
                connection.on("ReceiveNotification", function (message) {
                    console.log("Notification received:", message);
                    showNotification(message);
                });
            }

            function showNotification(message) {
                // Using SweetAlert for notifications
                Swal.fire({
                    title: "New Order!",
                    text: message,
                    icon: "info",
                    timer: 5000,
                    showConfirmButton: false,
                    position: 'top-end',
                    toast: true
                });
            }

            fetch('https://localhost:44365/api/Pizzadmin/addOrder', {
    method: 'POST',
    headers: {
        'Content-Type': 'application/json',
        'Accept': 'application/json'
    },
    body: JSON.stringify({
        productIds: productIds,
        quantities: quantities,
        totalPrice: totalPrice
    })
})
.then(response => response.json())
.then(data => {
    console.log('Server response:', data);
    if (data.success) {
        // Show success message (optional)
        Swal.fire({
            title: data.message,
            text: "Order Placed Successfully!",
            icon: "success",
            confirmButtonText: 'Ok',
            confirmButtonColor: '#b80818',
            allowOutsideClick: false,
            allowEscapeKey: false
        }).then((result) => {
            // Redirect using the URL from server
            window.location.href = "index.html";
        });
        
    } else {
        Swal.fire({
            title: "Oops...",
            text: "Something went wrong!",
            icon: "error"
        });
    }
})
    .catch(error => console.error('Error:', error));
        }
    </script>

</body>
</html>